<!-- src/app/pages/products/products.html -->
<section>
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-3xl font-extrabold text-slate-900">Productos</h1>
      <p class="text-slate-500">Gestiona tu inventario de productos</p>
    </div>
    <button
      type="button"
      (click)="openNew()"
      class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 transition"
    >
      Nuevo Producto
    </button>
  </div>

  <!-- Lista / Empty state -->
  <div class="rounded-xl border border-slate-200 bg-white overflow-hidden">
  <ng-container *ngIf="products.length > 0; else empty">
  <table class="min-w-full text-sm">
    <thead class="bg-slate-50 text-slate-600">
      <tr>
        <th class="text-left px-4 py-3">ID</th>
        <th class="text-left px-4 py-3">Nombre</th>
        <th class="text-left px-4 py-3">Categoría</th>
        <th class="text-left px-4 py-3">Sexo</th>
        <th class="text-left px-4 py-3">Tallas</th>
        <th class="text-left px-4 py-3">Colores</th>
        <th class="text-left px-4 py-3">Precio</th>
        <th class="text-left px-4 py-3">Stock</th>
        <th class="text-right px-4 py-3">Acciones</th>
      </tr>
    </thead>

    <tbody>
      <tr
        *ngFor="let p of products; trackBy: trackByProductId"
        class="border-t hover:bg-slate-50 transition"
      >
        <td class="px-4 py-3 font-medium text-slate-800">{{ p.id }}</td>
        <td class="px-4 py-3">{{ p.nombre }}</td>
        <td class="px-4 py-3">
          {{ p.categoriaNombre || categoriesMap[p.categoriaId] || 'Sin categoría' }}
        </td>
        <td class="px-4 py-3">
          <span
            class="px-2 py-0.5 rounded text-xs font-semibold"
            [ngClass]="{
              'bg-blue-100 text-blue-700': p.categoriaSexo === 'HOMBRE',
              'bg-pink-100 text-pink-700': p.categoriaSexo === 'MUJER'
            }"
          >
            {{ p.categoriaSexo || '—' }}
          </span>
        </td>

        <td class="px-4 py-3">
          <span
            *ngFor="let t of p.talla"
            class="inline-block px-2 py-0.5 rounded bg-slate-100 text-slate-700 mr-1 mb-1 text-xs font-medium"
          >
            {{ t }}
          </span>
        </td>

        <td class="px-4 py-3">
          <span
            *ngFor="let c of p.color"
            class="inline-block w-4 h-4 rounded-full border border-slate-300 mr-1"
            [style.backgroundColor]="c"
            [title]="c"
          ></span>
        </td>

        <td class="px-4 py-3">S/ {{ p.precio | number: '1.2-2' }}</td>
        <td class="px-4 py-3">{{ p.stock }}</td>

        <td class="px-4 py-3 text-right space-x-2">
          <button
            (click)="openEdit(p)"
            class="px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-100 text-slate-700"
          >
            Editar
          </button>
          <button
            (click)="delete(p)"
            class="px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-rose-50 text-rose-600"
          >
            Eliminar
          </button>
        </td>
      </tr>
    </tbody>
  </table>
</ng-container>

    <ng-template #empty>
      <div class="p-12 text-center">
        <div class="text-slate-600 font-semibold mb-1">No hay productos</div>
        <div class="text-slate-500 mb-4">Comienza agregando tu primer producto</div>
        <button
          type="button"
          (click)="openNew()"
          class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700"
        >
          Agregar Producto
        </button>
      </div>
    </ng-template>
  </div>

  <!-- ===== Modal Crear/Editar Producto ===== -->
  <div *ngIf="showModal" class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/40" (click)="closeModal()"></div>

    <div class="relative bg-white w-full max-w-2xl mx-4 rounded-2xl shadow-xl border border-slate-200">
      <div class="px-6 py-4 border-b">
        <h2 class="text-lg font-bold">
          {{ isEdit ? 'Editar Producto' : 'Nuevo Producto' }}
        </h2>
      </div>

      <!-- ÚNICO form -->
      <form #f="ngForm" (ngSubmit)="save(f)" class="px-6 py-5 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Nombre -->
          <div>
            <label class="block text-sm font-medium mb-1">Nombre *</label>
            <input
              [(ngModel)]="form.nombre"
              name="nombre"
              required
              #nombre="ngModel"
              class="w-full p-2.5 border rounded-lg focus:ring-2 focus:ring-indigo-500"
            />
            <p *ngIf="nombre.invalid && nombre.touched" class="text-xs text-rose-600 mt-1">
              El nombre es obligatorio.
            </p>
          </div>

          <!-- Precio -->
          <div>
            <label class="block text-sm font-medium mb-1">Precio *</label>
            <input
              type="number"
              min="0.01"
              step="0.01"
              [(ngModel)]="form.precio"
              name="precio"
              required
              #precio="ngModel"
              class="w-full p-2.5 border rounded-lg focus:ring-2 focus:ring-indigo-500"
            />
            <p *ngIf="(precio.invalid && precio.touched) || (form.precio<=0 && precio.touched)"
               class="text-xs text-rose-600 mt-1">
              Ingrese un precio válido.
            </p>
          </div>

          <!-- Stock -->
          <div>
            <label class="block text-sm font-medium mb-1">Stock</label>
            <input
              type="number"
              min="0"
              [(ngModel)]="form.stock"
              name="stock"
              #stock="ngModel"
              class="w-full p-2.5 border rounded-lg focus:ring-2 focus:ring-indigo-500"
            />
          </div>

          <!-- Categoría -->
          <div>
            <label class="block text-sm font-medium mb-1">Categoría *</label>
            <select
              [(ngModel)]="form.categoriaId"
              name="categoriaId"
              required
              #categoriaId="ngModel"
              class="w-full p-2.5 border rounded-lg focus:ring-2 focus:ring-indigo-500"
            >
              <option [ngValue]="0">Selecciona una categoría</option>
              <option *ngFor="let c of categories" [ngValue]="c.id">{{ c.nombre }}</option>
            </select>
            <p *ngIf="categoriaId.invalid && categoriaId.touched" class="text-xs text-rose-600 mt-1">
              Selecciona una categoría.
            </p>
          </div>

          <!-- Sexo -->
          <div>
            <label class="block text-sm font-medium mb-1">Sexo *</label>
            <select
              [(ngModel)]="form.categoriaSexo"
              name="categoriaSexo"
              required
              #categoriaSexo="ngModel"
              class="w-full p-2.5 border rounded-lg focus:ring-2 focus:ring-indigo-500"
            >
              <option value="">Selecciona un sexo</option>
              <option *ngFor="let s of availableSexos" [value]="s">{{ s }}</option>
            </select>
            <p *ngIf="categoriaSexo.invalid && categoriaSexo.touched" class="text-xs text-rose-600 mt-1">
              Selecciona el sexo al que pertenece el producto.
            </p>
          </div>

     

          <!-- Descripción -->
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Descripción</label>
            <textarea
              [(ngModel)]="form.descripcion"
              name="descripcion"
              rows="3"
              class="w-full p-2.5 border rounded-lg focus:ring-2 focus:ring-indigo-500"
            ></textarea>
          </div>

          <!-- Imágenes -->
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Imágenes del producto</label>

            <div class="flex items-center gap-4">
              <input
                type="file"
                multiple
                accept="image/*"
                (change)="onFilesSelected($event)"
                class="block w-full text-sm text-slate-700
                      file:mr-4 file:py-2 file:px-4
                      file:rounded-lg file:border-0
                      file:text-sm file:font-semibold
                      file:bg-indigo-50 file:text-indigo-700
                      hover:file:bg-indigo-100"
              />
            </div>

            <div class="flex flex-wrap gap-3 mt-3">
              <div *ngFor="let src of previews; let i = index" class="relative">
                <div class="w-20 h-20 rounded overflow-hidden border">
                  <img [src]="src" alt="Vista previa" class="w-full h-full object-cover" />
                </div>
                <button
                  type="button"
                  (click)="removeImageAt(i)"
                  class="absolute -top-2 -right-2 w-7 h-7 rounded-full bg-white border shadow
                        hover:bg-slate-50 text-slate-700 text-xs"
                  title="Quitar imagen"
                >
                  ✕
                </button>
              </div>
            </div>

            <small class="text-slate-500 block mt-1">
              Puedes seleccionar varias imágenes.
            </small>
          </div>

          <!-- Tallas -->
          <div>
            <label class="block text-sm font-medium mb-1">Tallas *</label>
            <div class="flex flex-wrap gap-2">
              <button
                type="button"
                *ngFor="let s of availableSizes"
                (click)="toggleSize(s)"
                [class.bg-blue-600]="form.talla.includes(s)"
                [class.text-white]="form.talla.includes(s)"
                class="px-2 py-1 border rounded"
              >
                {{ s }}
              </button>
            </div>
            <p *ngIf="form.talla.length === 0 && f.submitted" class="text-xs text-rose-600 mt-1">
              Selecciona al menos una talla.
            </p>
          </div>

          <!-- Colores -->
          <div>
            <label class="block text-sm font-medium mb-1">Colores</label>
            <div class="flex flex-wrap gap-2">
              <button
                type="button"
                *ngFor="let c of availableColors"
                (click)="toggleColor(c.value)"
                [style.backgroundColor]="c.value"
                [class.border-4]="form.color.includes(c.value)"
                class="w-8 h-8 rounded-full border"
                [title]="c.name"
              ></button>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" (click)="closeModal()" class="px-4 py-2 rounded-lg bg-slate-200 hover:bg-slate-300">
            Cancelar
          </button>
          <button
            type="submit"
            [disabled]="
              f.invalid ||
              form.talla.length === 0 ||
              form.categoriaId === 0 ||
              form.precio <= 0 ||
              !form.categoriaSexo
            "
            class="px-4 py-2 rounded-lg text-white
                   disabled:opacity-50 disabled:cursor-not-allowed
                   bg-green-600 hover:bg-green-700"
          >
            {{ isEdit ? 'Actualizar' : 'Guardar' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</section>
